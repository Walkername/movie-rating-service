<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">
    
    <changeSet id="create-user-profile-table" author="walkername">
        <createTable tableName="user_profile">
            <column name="id" type="bigint" >
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="username" type="VARCHAR(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(500)" defaultValue="">
                <constraints nullable="true"/>
            </column>
            <column name="average_rating" type="NUMERIC(4,2)" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="scores" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="profile_pic_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="role" type="VARCHAR" defaultValue="USER">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMPTZ" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMPTZ" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <sql>
            alter table user_profile alter column id add generated by default as identity;
        </sql>

        <sql>
            alter table user_profile
                add constraint ck_user_profile_average_rating
                    check (average_rating &lt;= 10.00)
        </sql>

        <sql>
            alter table user_profile
                add constraint chk_user_role
                    check (role in ('USER', 'ADMIN'))
        </sql>

        <createIndex
                tableName="user_profile"
                indexName="idx_user_profile_username_unique"
                unique="true">
            <column name="username"/>
        </createIndex>

    </changeSet>
    
</databaseChangeLog>